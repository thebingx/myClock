<!DOCTYPE html>
<html>
    <head>
        <title>My World Clock</title>
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script src="moment.js"></script>
        <script src="moment-timezone-with-data-10-year-range.js"></script>
        <link
            rel="stylesheet"
            type="text/css"
            href="index.css"
        />
        <script type="text/x-template" id="modal-template">
            <transition name="modal">
              <div class="modal-mask">
                <div class="modal-wrapper">
                  <div class="modal-container">
      
                    <div class="modal-header">
                      <slot name="header">
                        Settings
                      </slot>
                    </div>
      
                    <div class="modal-body">
                      <slot name="body">
                        Here are some modals
                      </slot>
                    </div>
      
                    <div class="modal-footer">
                      <slot name="footer">
                        When you are done, click OK.
                        <button class="modal-default-button" @click="$emit('close')">
                          OK
                        </button>
                      </slot>
                    </div>
                  </div>
                </div>
              </div>
            </transition>
          </script>
    </head>
  
    <body>
        <div id="clockContainer">
            <world-clock
                v-for = "item in citylist"
                v-bind:key = "item.id"
                v-bind:todo = "item"
            ></world-clock>
            <div>
                <button id="show-modal" @click="showModal = true" class="settings_button">
                  <img src="settings.svg" />
                </button>
                <!-- use the modal component, pass in the prop -->
                <modal v-if="showModal" @close="saveSettings">
                  <div slot="body">Clock Settings Here:
                      <clock-items
                        v-for = "post in citylist"
                        v-bind:key = "post.id"
                        v-bind:post = "post"
                      ></clock-items>
                      <div>
                        <span>
                          <label>Add Clock: </label>
                          <select class="settingName" id="timezone">
                            <option v-for="tz in tzlist" :key="tz.value" :value="tz.value">
                              {{ tz.name }}
                            </option>
                          </select>
                        </span>
                        <span>
                          <button
                          class="destroy"
                          @click="addClock"
                          >+
                        </button>
                        </span>
                      </div>
                  </div>
                  <h3 slot="header">Settings</h3>
                </modal>
            </div>
        </div>
    </body>
</html>

<script>
// localStorage persistence
let STORAGE_KEY = "myclock-0.3";

let myclockStorage = {
  fetch: function() {
    let myclocks = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    myclocks.forEach(function(myclock, index) {
      myclock.id = index;
    });
    myclockStorage.uid = myclocks.length;
    return myclocks;
  },
  save: function(myclocks) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(myclocks));
  }
};


// Define a clock component
Vue.component('world-clock', {
    props: ['todo'],
    template: '<div class="clock"><p class="date">{{ todo.date }}</p><p class="time">{{ todo.time }}</p><p class="text">{{ todo.name }}</p></div></div>'
})

// register modal component
Vue.component("modal", {
    template: "#modal-template"
});

Vue.component('clock-items', {
    props: ['post'], 
    template: '<div><span>Name: <input v-model="post.name" class="settingName"></span><span><span><button class="destroy" @click="removeClock(post)">X</button></span></div>',
    methods: {
      removeClock: function(id) {
        clock.citylist.splice(clock.citylist.indexOf(id), 1);
      }
    }
})


let clock = new Vue({
    el: '#clockContainer',
    
    data: {
        time: '',
        date: '',
        newClock: '',
        showModal: false,
        citylist: myclockStorage.fetch(),
        tzlist: getTzlist()
    },
    
    watch: {
        citylist: {
            handler: function(citylist) {
                myclockStorage.save(citylist);
            },
        }
    },

    methods: {
        addClock: function() {
            cityname = document.getElementById('timezone').value;
            this.citylist.push ({
              id: this.citylist.length + 1,
              name: cityname,
            })
            updateTime();
        },

        saveSettings: function() {
          this.showModal = false;
          myclockStorage.save(this.citylist);
        }
    }
});


var week = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
var timerID = setInterval(updateTime, 1000);
//setInterval(updateTime, 1000);


function getTzlist() {
          let list = [];
          let tz = moment.tz.names()
          tz.forEach( item => list.push({ value: item, name: item}))
          return list;
}

function updateTime() {
    for (i in clock.citylist) {
        zone = clock.citylist[i].name;

        let cd = new Date();
        time = moment.tz(cd, zone).format('HH:mm:ss');
        date = moment.tz(cd, zone).format('YYYY-MM-DD') + ' ' + week[moment.tz(cd, zone).day()];

        clock.citylist[i].time = time;
        clock.citylist[i].date = date;
    }
};

</script>