<!DOCTYPE html>
<html>
    <head>
        <title>My World Clock</title>
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
        <script src="moment.js"></script>
        <script src="moment-timezone-with-data.js"></script>
        <link
            rel="stylesheet"
            type="text/css"
            href="index.css"
        />
        <script type="text/x-template" id="modal-template">
            <transition name="modal">
              <div class="modal-mask">
                <div class="modal-wrapper">
                  <div class="modal-container">
      
                    <div class="modal-header">
                      <slot name="header">
                        Settings
                      </slot>
                    </div>
      
                    <div class="modal-body">
                      <slot name="body">
                        Here are some modals
                      </slot>
                    </div>
      
                    <div class="modal-footer">
                      <slot name="footer">
                        When you are done, click OK.
                        <button class="modal-default-button" @click="$emit('close')">
                          OK
                        </button>
                      </slot>
                    </div>
                  </div>
                </div>
              </div>
            </transition>
          </script>
    </head>
  
    <body>
        <div id="clockContainer">
            <world-clock
                v-for = "item in citylist"
                v-bind:key = "item.id"
                v-bind:todo = "item"
            ></world-clock>
            <div>
                <button id="show-modal" @click="showModal = true" class="settings_button">
                  <img src="settings.svg" />
                </button>
                <!-- use the modal component, pass in the prop -->
                <modal v-if="showModal" @close="saveSettings">
                  <div slot="body">Clock Settings Here:
                      <clock-items
                        v-for = "post in citylist"
                        v-bind:key = "post.id"
                        v-bind:post = "post"
                      ></clock-items>
                      <div>
                          <span>
                            Name: 
                            <input
                              placeholder="add Clock"
                              v-model="newClock"
                              class="settingName"
                            >
                          </span>
                          <span>
                            UTC Offset: 
                            <input
                              placeholder="8"
                              V-model="newZone"
                              class="settingZone"
                            >
                          </span>
                          <span>
                            <button
                              class="destroy"
                              @click="addClock"
                            >+
                            </button>
                          </span>
                      </div>
                      <div>
                        <span>
                          <label>Name: </label>
                          <select class="settingName" id="timezone">
                            <option v-for="tz in tzlist" :key="tz.value" :value="tz.value">
                              {{ tz.name }}
                            </option>
                          </select>
                        </span>
                        <span>
                          <button
                          class="destroy"
                          @click="addClock2"
                          >+
                        </button>
                        </span>
                      </div>
                  </div>
                  <h3 slot="header">Settings</h3>
                </modal>
            </div>
        </div>
    </body>
</html>

<script>

// localStorage persistence
var STORAGE_KEY = "myclock-0.3";
var myclockStorage = {
  fetch: function() {
    var myclocks = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    myclocks.forEach(function(myclock, index) {
      myclock.id = index;
    });
    myclockStorage.uid = myclocks.length;
    return myclocks;
  },
  save: function(myclocks) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(myclocks));
  }
};


// Define a clock component
Vue.component('world-clock', {
    props: ['todo'],
    template: '<div class="clock"><p class="date">{{ todo.date }}</p><p class="time">{{ todo.time }}</p><p class="text">{{ todo.name }}</p></div></div>'
})

// register modal component
Vue.component("modal", {
    template: "#modal-template"
});

Vue.component('clock-items', {
    props: ['post'], //['id', 'name', 'zone'],
    template: '<div><span>Name: <input v-model="post.name" class="settingName"></span><span> UTC Offset: <input class="settingZone" v-model="post.zone"></span><span> <button class="destroy" @click="handleClick(post)">X</button></span></div>',
    methods: {
      handleClick: function(id) {
        clock.citylist.splice(clock.citylist.indexOf(id), 1);
      }
    }
})

// Vue.component('timezones'), {
//   props: ['tz'],
//   template: '<option value="{{ tz.value }}">{{ tz.name }}</option>'
// }


var clock = new Vue({
    el: '#clockContainer',
    
    data: {
        time: '',
        date: '',
        newClock: '',
        newZone: '',
        showModal: false,
        citylist: myclockStorage.fetch(),
        tzlist: [
          {value: 'sh', name: 'Shanghai'},
          {value: 'ny', name: 'New York'}
        ]
    },
    
    watch: {
        citylist: {
            handler: function(citylist) {
                myclockStorage.save(citylist);
            },
        }
    },

    methods: {
        addClock: function() {
            this.citylist.push ({
                id: this.citylist.length + 1,
                name: this.newClock,
                zone: this.newZone,
            })
            this.newClock = '';
            updateTime();
        },

        addClock2: function() {

            alert('called');
        },

        removeClock: function(currentclock) {
            // this function doesn't work yet, need to fit!
            //alert(currentclock);
            //this.citylist.splice(this.citylist.indexOf(currentclock), 1);
            console.log('received!');
        },

        saveSettings: function() {
          this.showModal = false;
          myclockStorage.save(this.citylist);
        }
    }
});

let tz = moment.tz.names()

// let optionList = document.getElementById('timezone').options;

console.log(tz)

// tz.forEach( option =>
//     optionList.add(
//         new Option(option)
//     )
// )


var week = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
var timerID = setInterval(updateTime, 1000);
//setInterval(updateTime, 1000);

function updateTime() {
    for (i in clock.citylist) {
        offset = clock.citylist[i].zone;
        cd = calcTime(offset)
        clock.citylist[i].time = zeroPadding(cd.getHours(), 2) + ':' + zeroPadding(cd.getMinutes(), 2) + ':' + zeroPadding(cd.getSeconds(), 2);
        clock.citylist[i].date = zeroPadding(cd.getFullYear(), 4) + '-' + zeroPadding(cd.getMonth()+1, 2) + '-' + zeroPadding(cd.getDate(), 2) + ' ' + week[cd.getDay()];
    }
};

function zeroPadding(num, digit) {
    var zero = '';
    for(var i = 0; i < digit; i++) {
        zero += '0';
    }
    return (zero + num).slice(-digit);
}

function calcTime(offset) {
    //create Date object for current location
    var d = new Date();

    //conver to msec
    //subtract local time zone offset
    var utc = d.getTime() + (d.getTimezoneOffset() * 60000);

    //create new Date object for different city
    //using suppied offset
    var nd = new Date(utc + (3600000 * offset));

    //return time as a string
    return nd
}

</script>